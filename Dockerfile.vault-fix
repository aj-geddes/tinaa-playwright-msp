FROM ghcr.io/aj-geddes/tinaa-playwright-msp:latest

# Update the startup script to source Vault secrets
RUN echo '#!/bin/bash\n\
# TINAA HTTP Server Startup Script with Vault Integration\n\
\n\
# Source all Vault secrets if they exist\n\
if [ -d "/vault/secrets" ]; then\n\
    echo "Loading Vault secrets..."\n\
    for secret in /vault/secrets/*; do\n\
        if [ -f "$secret" ]; then\n\
            echo "  Sourcing: $(basename $secret)"\n\
            source "$secret"\n\
        fi\n\
    done\n\
    echo "Vault secrets loaded successfully"\n\
else\n\
    echo "No Vault secrets directory found, continuing without secrets"\n\
fi\n\
\n\
# Change to app directory\n\
cd /app\n\
\n\
# Log startup information\n\
echo "Starting TINAA HTTP server in directory $(pwd)..." > /app/logs/startup_http.log\n\
echo "Python path: $PYTHONPATH" >> /app/logs/startup_http.log\n\
echo "Starting on port 8765..." >> /app/logs/startup_http.log\n\
\n\
# Log loaded secrets (without exposing values)\n\
echo "Environment check:" >> /app/logs/startup_http.log\n\
[ -n "$TINAA_ANTHROPIC_API_KEY" ] && echo "  ✓ Anthropic API key loaded" >> /app/logs/startup_http.log\n\
[ -n "$TINAA_OPENAI_API_KEY" ] && echo "  ✓ OpenAI API key loaded" >> /app/logs/startup_http.log\n\
[ -n "$TINAA_GIT_PAT" ] && echo "  ✓ Git PAT loaded" >> /app/logs/startup_http.log\n\
[ -n "$TINAA_GIT_APP_ID" ] && echo "  ✓ GitHub App credentials loaded" >> /app/logs/startup_http.log\n\
\n\
# Start the HTTP server\n\
exec python /app/app/http_server.py\n\
' > /app/startup_http.sh && chmod +x /app/startup_http.sh

# Also copy the updated secrets_manager.py
COPY app/secrets_manager.py /app/app/secrets_manager.py